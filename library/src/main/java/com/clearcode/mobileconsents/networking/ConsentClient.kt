package com.clearcode.mobileconsents.networking

import com.clearcode.mobileconsents.Consent
import com.clearcode.mobileconsents.adapter.extension.parseToRequestBody
import com.clearcode.mobileconsents.networking.request.ConsentRequestJsonAdapter
import com.clearcode.mobileconsents.system.ApplicationProperties
import com.clearcode.mobileconsents.toRequest
import com.clearcode.mobileconsents.util.getUtcDate
import com.squareup.moshi.Moshi
import okhttp3.Call
import okhttp3.HttpUrl
import okhttp3.Request
import java.util.UUID

private const val consentJsonFileName = "consent-data.json"

/**
 * Client responsible for creating [Call]s to the CDN and partners server.
 */
internal class ConsentClient(
  private val getUrl: HttpUrl,
  private val postUrl: HttpUrl,
  private val callFactory: Call.Factory,
  private val moshi: Moshi
) {

  /**
   * Get consent from CDN server.
   * @param consentSolutionId [UUID] of consent solution.
   */
  fun getConsentSolution(consentSolutionId: UUID): Call {
    val url = getUrl.newBuilder()
      .addPathSegment(consentSolutionId.toString())
      .addPathSegment(consentJsonFileName)
      .build()
    val request = Request.Builder().url(url).build()

    return callFactory.newCall(request)
  }

  /**
   * Post [Consent] to partner server (URL specified in SDK's builder)
   * @param consent object containing user's consents, platform information and custom data.
   * @param userId [UUID] generated by SDK, unique per app installation.
   * @param date time of request, in ISO 8601 format.
   */
  fun postConsent(
    consent: Consent,
    userId: UUID,
    applicationProperties: ApplicationProperties,
    date: String = getUtcDate()
  ): Call {
    val adapter = ConsentRequestJsonAdapter(moshi)
    val requestBody = adapter.parseToRequestBody(consent.toRequest(userId, date, applicationProperties))

    val url = postUrl.newBuilder()
      .addPathSegment("consents")
      .build()

    val request = Request.Builder()
      .url(url)
      .post(requestBody)
      .build()

    return callFactory.newCall(request)
  }
}
